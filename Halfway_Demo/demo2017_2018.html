<!DOCTYPE html>
<html>
<head>
	
	<title>Map Project</title>
	

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js" integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg==" crossorigin=""></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/13.1.1/nouislider.js" integrity="sha256-RSuaLYAi3KF8Dt9ftncQaaJt6ZAJs1QxETdEFghKvvE=" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/13.1.1/nouislider.css" integrity="sha256-OFKKJT+zg7E+i5NVtrHToDVtOVBBfAdpvFyWHzztaCU=" crossorigin="anonymous" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha256-1fEPhSsRKlFKGfK3eO710tEweHh1fwokU5wFGDHO+vg=" crossorigin="anonymous"></script>
	<script src="EdmontonPA_out\data_list.js"></script>
	<script src="prop_info_out\prop_list.js"></script>
	<script src="prop_info_out\account_list.js"></script>

	
  


	
</head>
<body bgcolor="#f5f2f0">

<div id="header_text" align=center style="margin:auto; width: 90%; height:auto;">
	<p style="font-size:24px;"><b>
		Edmonton Proptey Asssment Change Between 2017 and 2018
	</b></p>
</div>

<div id="parent" align=center style="margin:auto; width: 90%; height:500px;">
	<div style="float:left; width:90%; height:100%;">
		<div id="mapid" style="float: center; height:100%"></div>
	</div>
	<div style="float:right; width:10%; height:90%;">
		<div style="width: 90%; height:5%;"></div>
		<div id="color_legend" style="float: center; width: 90%; height:90%;">
			>10%
			<img src="color_map.jpg" alt="Color legend" style="max-height:100%; max-width:100%;">
			<10%
		</div>
	</div>

</div>

<script>


var parent = document.getElementById("parent");
var page_height = (window.innerHeight-24)*0.9;

parent.style.height = page_height + "px";

window.onload = window.onresize = function () {
	page_height = (window.innerHeight-24)*0.9;
	parent.style.height = page_height + "px";    
	
}



require(['domReady.js']);

require.config({
    waitSeconds: 600 // set the wait seconds to be high since we will need to require a lot of data
  });

// we need a function to get all the data segments   
var get_file = function(obj_list, str,path_to_data){
	if (typeof obj_list[str] != "undefined" && obj_list[str]!=null ){
		// get the small segments of the data
		require([path_to_data+'\\'+str]);
		for (i=1;i<=obj_list[str];i++){	
			require([path_to_data+'\\'+str+'_'+String(i)], function () {
				// call the fuse_data function to peice segments together
				fuse_data(obj_list, str);
			});

		}		
		
	}
}

// this function is to fuse small segments of data together
var fuse_data = function(obj_list, str){
		for (j=1;j<=obj_list[str];j++){				
			// try case is used since the data might not be required yet
			// since we will be calling this function many times,
			// it will fuse everythint eventually 
			try {
				// this try case is for array type of data
				eval(str+'='+ str+'.concat('+str+'_'+String(j)+')');// add additional segment to the main segment
				eval(str+'_'+String(j)+'=[]');// delete the small peice
			}
			catch(err) {
				// the try case for object data type
				try{
				eval(str+'=Object.assign('+str+', '+str+'_'+String(j)+')');
				eval(str+'_'+String(j)+'={}');
				
				}
				catch{
					// no action expected
				}
			  
			}	
				
		}

}


// get points to plot base on some requirements
// not really useful right now, but it will be used to
// filter the data points when the UI is implemented 
var getPoints=function(data1,data2,loc) {
	result_loc=[];
	arr_length=account_list.length;
	for (var i=0; i<arr_length;i++){
		try{
			acc_num=account_list[i]
			prop_info_obj=loc[acc_num];
			result_loc[i]=[data1[acc_num]["Assessed Value"]/data2[acc_num]["Assessed Value"]-1,prop_info_obj.Latitude,prop_info_obj.Longitude];
			}
		catch(err) {
		}
				
		
	}
	
	return result_loc;
	
}

// get the RGB color to plot on the border of the circle markers
var get_color = function(val,min_val,max_val){
		
		if (val<min_val) val=min_val;
		if (val>max_val) val=max_val;
		val=val-min_val;
		x=val/(max_val-min_val)
		
		
		r=-2137.4*x**3 + 2901.2*x**2 - 699.89*x + 53.852;
		g= 1318.5*x**3 - 2081.3*x**2 + 640.72*x + 153.38;
		b= 447.08*x**3 + 154.21*x**2 - 588.78*x + 206.78;
		
        return 'rgb('+Math.round(r)+','+Math.round(g)+','+Math.round(b)+')' ;
	
}


	// set up the map use leaflet
	var mymap = L.map('mapid', {
        renderer: L.canvas()
    });
	mymap.setView([53.532146, -113.502502], 12);
	
	// add map tile from wikimedia. Thanks wiki!
	L.tileLayer('https://maps.wikimedia.org/osm-intl/{z}/{x}/{y}{r}.png', {
		maxZoom: 18,
		attribution: '<a href="https://rayliu.ca">Ray Liu</a>, '+ 
			'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
			'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' + 
			'<a href="https://wikimediafoundation.org/wiki/Maps_Terms_of_Use">Wikimedia</a>',
		id: 'OpenStreetMap.Mapnik'
	}).addTo(mymap);
	
	// set a layer group so the points can be easily removed
	data_points=L.layerGroup().addTo(mymap)
	

	
	
	c_radius=5;// set circle radius to be 5m
	

     // plot points as circle markers on the leaflet map
	function plot_points(arr){
		arr_length=arr.length;
		for (var i = 0; i < arr_length; i++) {
			if (typeof arr[i] != "undefined" && arr[i]!=null){
				
				//make the marker
				marker = new L.circle([arr[i][1],arr[i][2]],{ radius:c_radius, color:(get_color(arr[i][0],-0.1,0.1))})
				.bindPopup("Assessment Change: "+ (arr[i][0]*100).toPrecision(3).toString()+'%') // add the pop up text
				.addTo(data_points);
			}
		}
		
	}


	var popup = L.popup(); // set the pop up layer
	
	// get the assessment data in this demo, the property assessment of 2018 and 2017
	get_file(data_list,'year2018','EdmontonPA_out');
	get_file(data_list,'year2017','EdmontonPA_out');
	
	// the geo location of the accounts
	get_file(prop_list,'prop_info','prop_info_out');

	// the main function first setup the markers and plot them
	var main = function(){
	
		marker_loc=getPoints(year2018,year2017,prop_info);
		return plot_points(marker_loc);
	
	}
	

	window.addEventListener('load', 
	  function() { 
		main();
	  }, false);


	

	

</script>



</body>
</html>
